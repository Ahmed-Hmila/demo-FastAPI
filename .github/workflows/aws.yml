name: Build & Push Lambda Container Image

on:
  push:
    branches:
      - master
  workflow_dispatch:   # Pour lancer manuellement

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-west-3
  ECR_REPOSITORY: ahmed-demo-lab-py
  PROJECT_NAME: fast-api          # ← Change si besoin
  TEAM: data-eng
  ENV: dev

jobs:
  build-push-lambda:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Génère un timestamp unique
      - name: Set timestamp
        run: echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

      # Crée le tag avec métadonnées intégrées
      - name: Generate image tag with metadata
        run: |
          METADATA_TAG="lambda-${{ env.TIMESTAMP }}-${{ env.PROJECT_NAME }}-${{ env.TEAM }}-${{ env.ENV }}"
          echo "IMAGE_TAG=$METADATA_TAG" >> $GITHUB_ENV
          echo "Tag final : $METADATA_TAG"

      # Auth AWS via OIDC (même rôle que avant)
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::380426548948:role/Ahmed-OIDC-Role
          aws-region: ${{ env.AWS_REGION }}

      # Récupère l'URL du repository ECR existant
      - name: Get ECR Repository URL
        run: |
          ECR_URL=$(aws ecr describe-repositories \
            --repository-names ${{ env.ECR_REPOSITORY }} \
            --region ${{ env.AWS_REGION }} \
            --query 'repositories[0].repositoryUri' \
            --output text)
          echo "ECR_URL=$ECR_URL" >> $GITHUB_ENV
          echo "Repository ECR trouvé : $ECR_URL"

      # Connexion ECR (même méthode que ton code original)
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ env.ECR_URL }}

      # Build uniquement l'image Lambda
      - name: Build Lambda Docker image
        run: |
          docker build -f Dockerfile.lambda -t app-lambda:${{ env.IMAGE_TAG }} .

      # Tag & Push l'image Lambda
      - name: Tag and Push Lambda image
        run: |
          FULL_IMAGE="${{ env.ECR_URL }}:${{ env.IMAGE_TAG }}"
          docker tag app-lambda:${{ env.IMAGE_TAG }} $FULL_IMAGE
          docker push $FULL_IMAGE
          echo "Image Lambda poussée : $FULL_IMAGE"

          # Optionnel : tag latest pour facilité en dev
          docker tag app-lambda:${{ env.IMAGE_TAG }} ${{ env.ECR_URL }}:latest
          docker push ${{ env.ECR_URL }}:latest

 
